name: æ‰“åŒ…æ¨¡å— # å·¥ä½œæµåç§°

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
    inputs:
      module: # æ¨¡å—é€‰æ‹©è¾“å…¥
        description: "é€‰æ‹©è¦æ‰“åŒ…çš„æ¨¡å—ç›®å½•"
        required: true
        default: "ctyun"
        type: choice
        options:
          - ctyun
          - nginx_proxy_manager
          - proxmox
          - synology
          - aawaf
          - safeline
          - xppanel
          - ratpanel
          - lucky
          - uuwaf
          - open_resty_manager
      arch: # æ¶æ„é€‰æ‹©è¾“å…¥
        description: "é€‰æ‹©æ¶æ„"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - amd64
          - arm64
      version: # æ–°å¢ï¼šç‰ˆæœ¬å·è¾“å…¥
        description: "è¾“å…¥æ’ä»¶ç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼‰"
        required: false # ç‰ˆæœ¬å·å¯ä»¥ä¸å¡«
        default: "" # é»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²
        type: string

jobs:
  build: # æ„å»ºä»»åŠ¡
    runs-on: ubuntu-latest # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬ä¸Šè¿è¡Œ
    permissions: # <--- æ ¸å¿ƒæ›´æ”¹ï¼šä¸ºæ•´ä¸ª Job æˆäºˆå†™å…¥æƒé™
      contents: write # æˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œè¿™é€šå¸¸åŒ…å«åˆ›å»º Release çš„æƒé™

    steps:
      - name: æ£€å‡ºä»£ç  # æ­¥éª¤ï¼šæ£€å‡º Git ä»“åº“ä»£ç 
        uses: actions/checkout@v4 # ä½¿ç”¨ actions/checkout@v4

      - name: è®¾ç½®Goç¯å¢ƒ # æ­¥éª¤ï¼šè®¾ç½® Go è¯­è¨€ç¯å¢ƒ
        uses: actions/setup-go@v5 # ä½¿ç”¨ actions/setup-go@v5
        with:
          go-version: "1.24" # æŒ‡å®š Go ç‰ˆæœ¬
          cache: true # å¯ç”¨ Go æ¨¡å—ç¼“å­˜ï¼ŒåŠ å¿«åç»­æ„å»ºé€Ÿåº¦

      - name: å®‰è£…ä¾èµ– # æ­¥éª¤ï¼šä¸‹è½½ Go æ¨¡å—ä¾èµ–
        run: go mod download

      - name: æ„å»ºæŒ‡å®šæ¨¡å— # æ­¥éª¤ï¼šæ ¹æ®é€‰æ‹©çš„æ¨¡å—å’Œæ¶æ„è¿›è¡Œæ„å»º
        run: |
          # æ‰“å°å½“å‰å·¥ä½œç›®å½•ï¼Œä»¥ä¾¿è°ƒè¯•
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p bin

          # æ£€æŸ¥ bin ç›®å½•æ˜¯å¦å·²åˆ›å»º
          echo "æ£€æŸ¥ bin/ ç›®å½•æ˜¯å¦å­˜åœ¨..."
          ls -ld bin/

          # å¤„ç†æ¨¡å—å‚æ•°ï¼šå¦‚æœé€‰æ‹© "all"ï¼Œåˆ™åˆ—å‡ºæ‰€æœ‰å­ç›®å½•ä½œä¸ºæ¨¡å—ï¼›å¦åˆ™ä½¿ç”¨æŒ‡å®šæ¨¡å—
          if [ "${{ github.event.inputs.module }}" = "all" ]; then
            # ls -d */ åˆ—å‡ºæ‰€æœ‰ç›®å½•ï¼Œgrep -v 'bin/' æ’ é™¤ bin ç›®å½•ï¼Œsed 's#/##' å»æ‰æ–œæ 
            MODULES=$(ls -d */ | grep -v 'bin/' | sed 's#/##')
          else
            # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æŒ‡å®šæ¨¡å—
            MODULES=${{ github.event.inputs.module }}
          fi

          # å¤„ç†æ¶æ„å‚æ•°ï¼šå¦‚æœé€‰æ‹© "all"ï¼Œåˆ™æ„å»º amd64 å’Œ arm64ï¼›å¦åˆ™ä½¿ç”¨æŒ‡å®šæ¶æ„
          if [ "${{ github.event.inputs.arch }}" = "all" ]; then
            ARCHES=(amd64 arm64) # å®šä¹‰æ”¯æŒçš„æ¶æ„æ•°ç»„
          else
            ARCHES=(${{ github.event.inputs.arch }}) # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æŒ‡å®šæ¶æ„
          fi

          # å¾ªç¯éå†æ¯ä¸ªæ¨¡å—è¿›è¡Œæ„å»º
          for module in $MODULES; do
            # æ£€æŸ¥æ¨¡å—ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”åŒ…å« Makefile æ–‡ä»¶
            if [ -d "$module" ] && [ -f "$module/Makefile" ]; then
              echo "--------------------------------------------------"
              echo "å¼€å§‹æ„å»ºæ¨¡å—: $module"
              echo "è¿›å…¥æ¨¡å—ç›®å½•: $(pwd)/$module"

              # å¾ªç¯éå†æ¯ä¸ªæ¶æ„è¿›è¡Œæ„å»º
              for arch in "${ARCHES[@]}"; do
                echo "æ„å»ºæ¶æ„: $arch"
                # æ‰§è¡Œ Makefile ä¸­çš„æ„å»ºå‘½ä»¤ï¼ŒOUTPUT æŒ‡å®šè¾“å‡ºè·¯å¾„
                # å‡è®¾ä½ çš„ Makefile ä¸­æœ‰ build-linux-amd64 å’Œ build-linux-arm64 ç­‰ç›®æ ‡
                # ***é‡è¦æç¤º***ï¼šè¯·ç¡®ä¿ä½ çš„æ¨¡å—å†…éƒ¨çš„ Makefile æ­£ç¡®ä½¿ç”¨äº† OUTPUT å˜é‡ã€‚
                # ä¾‹å¦‚ï¼Œåœ¨ä½ çš„ ctyun/Makefile ä¸­ï¼Œå¯èƒ½éœ€è¦ç±»ä¼¼è¿™æ ·çš„è§„åˆ™ï¼š
                # build-linux-amd64:
                #    GOOS=linux GOARCH=amd64 go build -o $(OUTPUT)/my_plugin_name-amd64 .
                # è¯·ç¡®ä¿ $(OUTPUT) è¢«æ­£ç¡®åœ°ç”¨ä½œæœ€ç»ˆäºŒè¿›åˆ¶æ–‡ä»¶çš„ç›®æ ‡ç›®å½•ã€‚
                make -C "$module" "build-linux-$arch" OUTPUT="$(pwd)/bin/$module"
              done
              echo "æ¨¡å— $module æ„å»ºå®Œæˆã€‚"
              echo "--------------------------------------------------"
            else
              # å¦‚æœæ¨¡å—ä¸å­˜åœ¨æˆ–ç¼ºå°‘ Makefileï¼Œåˆ™å‘å‡ºè­¦å‘Š
              echo "è­¦å‘Š: æ¨¡å— $module ä¸å­˜åœ¨æˆ–ç¼ºå°‘Makefile"
            fi
          done

          # æ„å»ºå®Œæˆåï¼Œåˆ—å‡º bin/ ç›®å½•çš„è¯¦ç»†å†…å®¹ï¼Œä»¥æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ç”Ÿæˆ
          echo "æ„å»ºå®Œæˆåï¼Œæ£€æŸ¥ bin/ ç›®å½•å†…å®¹ï¼š"
          ls -laR bin/ || echo "bin/ ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨æ–‡ä»¶ã€‚" # å¦‚æœ ls å¤±è´¥ï¼Œåˆ™æ‰“å°æ¶ˆæ¯

          # å°è¯•ä½¿ç”¨ tree å‘½ä»¤æ˜¾ç¤ºç›®å½•ç»“æ„ï¼Œå¦‚æœç³»ç»Ÿæ²¡æœ‰å®‰è£…åˆ™å¿½ç•¥é”™è¯¯
          command -v tree >/dev/null 2>&1 && echo "bin/ ç›®å½•æ ‘å½¢ç»“æ„ï¼š" && tree bin/ || echo "tree å‘½ä»¤æœªæ‰¾åˆ°ï¼Œæ— æ³•æ˜¾ç¤ºæ ‘å½¢ç»“æ„ã€‚"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© # æ­¥éª¤ï¼šä¸Šä¼ æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸ºå·¥ä½œæµäº§ç‰©ï¼Œä¾›åç»­ Release ä»»åŠ¡ä½¿ç”¨
        uses: actions/upload-artifact@v4 # ä½¿ç”¨ actions/upload-artifact@v4
        with:
          name: allinssl-build-artifacts # <--- æ ¸å¿ƒæ›´æ”¹ï¼šåç§°å›ºå®šä¸º 'allinssl-build-artifacts'
          path: bin/ # ä¸Šä¼  bin/ ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        continue-on-error: false # <--- æ–°å¢ï¼šå¦‚æœ bin/ ç›®å½•ä¸ºç©ºï¼Œåˆ™æ­¤æ­¥éª¤ä¼šå¤±è´¥ï¼Œå¯¼è‡´æ•´ä¸ª job å¤±è´¥

  release: # å‘å¸ƒä»»åŠ¡
    needs: build # ä¾èµ–äº build ä»»åŠ¡ï¼Œåªæœ‰ build æˆåŠŸåæ‰æ‰§è¡Œ
    runs-on: ubuntu-latest
    # ä»…å½“æ„å»ºæˆåŠŸæ—¶æ‰åˆ›å»º Release
    if: success()
    permissions: # <--- æ ¸å¿ƒæ›´æ”¹ï¼šä¸º release Job æ˜ç¡®æˆäºˆæƒé™
      contents: write # æˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™å…¥æƒé™ï¼Œè¿™é€šå¸¸åŒ…å«åˆ›å»º Release çš„æƒé™

    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰© # æ­¥éª¤ï¼šä¸‹è½½ build ä»»åŠ¡ä¸­ä¸Šä¼ çš„äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: allinssl-build-artifacts # ä¸ upload-artifact çš„ name ä¿æŒä¸€è‡´
          path: ./downloaded-artifacts # ä¸‹è½½åˆ°è¿™ä¸ªç›®å½•

      - name: åˆ›å»º Release # æ­¥éª¤ï¼šåˆ›å»º GitHub Release
        id: create_release # ä¸ºæ­¤æ­¥éª¤æŒ‡å®š IDï¼Œä»¥ä¾¿è·å–å…¶è¾“å‡º
        uses: softprops/action-gh-release@v1 # ä½¿ç”¨ softprops/action-gh-release@v1
        with:
          # æ ¹æ®æ˜¯å¦æä¾›äº†ç‰ˆæœ¬å·æ¥ç”Ÿæˆä¸åŒçš„ Tag åç§°
          tag_name: ${{ format('{0}-{1}', github.event.inputs.module, github.event.inputs.version || format('build-{0}', github.run_number)) }}
          # Release çš„æ ‡é¢˜
          name: ${{ github.event.inputs.module }} - ${{ github.event.inputs.arch }} æ’ä»¶ (${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || format('æ„å»º {0}', github.run_number) }})
          # Release çš„æè¿°ä¿¡æ¯
          body: |
            # è‡ªåŠ¨ç”Ÿæˆ Release
            - **æ¨¡å—**: ${{ github.event.inputs.module }}
            - **æ¶æ„**: ${{ github.event.inputs.arch }}
            - **ç‰ˆæœ¬å·**: ${{ github.event.inputs.version || 'æœªæŒ‡å®š' }}

            æ­¤ Release åŒ…å«äº†é’ˆå¯¹æ‰€é€‰æ¨¡å—å’Œæ¶æ„çš„æ‰“åŒ…æ–‡ä»¶ã€‚

            ğŸ‘‰ [æŸ¥çœ‹æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/${{ github.event.inputs.module }}/CHANGELOG.md)
          draft: false # æ˜¯å¦ä½œä¸ºè‰ç¨¿å‘å¸ƒ (true ä¸ºè‰ç¨¿ï¼Œfalse ä¸ºæ­£å¼å‘å¸ƒ)
          prerelease: false # æ˜¯å¦ä½œä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ (true ä¸ºé¢„å‘å¸ƒï¼Œfalse ä¸ºæ­£å¼å‘å¸ƒ)
          # å°†ä¸‹è½½çš„äº§ç‰©ä½œä¸º Release é™„ä»¶ä¸Šä¼ 
          files: ./downloaded-artifacts/**/* # åŒ¹é…ä¸‹è½½ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­æ–‡ä»¶
        env:
          # GITHUB_TOKEN æ˜¯ GitHub Actions è‡ªåŠ¨æä¾›çš„æƒé™ Tokenï¼Œç”¨äºè¿›è¡Œ API æ“ä½œ
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
